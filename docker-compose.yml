services:
  blockchain:
    build:
      context: ./Blockchain
      dockerfile: Chaincode/Dockerfile
      args:
        ENV: ${NODE_ENV:-development}
    image: jimmymaina/pesachain:blockchain${IMAGE_TAG}
    ports:
      - "7051:7051"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "pgrep", "chaincode"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  backend:
    build:
      context: ./Backend
      dockerfile: Dockerfile
      args:
        NODE_ENV: ${NODE_ENV:-development}
    image: jimmymaina/pesachain:backend-${IMAGE_TAG}
    ports:
      - "3000:3000"
    depends_on:
      - blockchain
    develop:
      watch:
        - path: ./Backend/package.json
          action: rebuild
        - path: ./Backend/package-lock.jsin
          action: rebuild
        - path: ./Backend
          target: /app
          action: sync
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:3000/health"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  frontend-mobile:
    build:
      context: ./Frontend/mobile
      args:
        ENV: ${NODE_ENV:-development}
    image: jimmymaina/pesachain:frontend-mobile-${IMAGE_TAG}
    depends_on:
      - backend
    develop:
      watch:
        - path: ./Frontend/mobile/package.json
          action: rebuild
        - path: ./Frontend/mobile/package-lock.jsin
          action: rebuild
        - path: ./Frontend/mobile
          target: /app
          action: sync
    ports:
      - "8081:8081"
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:8081"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

  frontend-web:
    build:
      context: ./Frontend/web/
      dockerfile: Dockerfile
      args:
        ENV: ${NODE_ENV:-development}
    image: jimmymaina/pesachain:frontend-web-${IMAGE_TAG}
    ports:
      - "8080:8080"
    depends_on:
      - backend
    develop:
      watch:
        - path: ./Frontend/web/package.json
          action: rebuild
        - path: ./Frontend/web/package-lock.jsin
          action: rebuild
        - path: ./Frontend/web
          target: /app
          action: sync
    networks:
      - app-network
    healthcheck:
      test: ["CMD", "curl", "--fail", "http://localhost:80"]
      interval: 30s
      timeout: 10s
      retries: 3
      start_period: 5s

networks:
  app-network:
    driver: bridge